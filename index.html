<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>CS 4731 Final Project Part I</title>
        <script id="vshader" type="x-shader/x-vertex">
            attribute vec4 vPosition, vNormal;
            uniform vec4 matDiffuse, matSpecular;
            attribute vec2 vTexture;

            uniform float onlyAmbient;
            uniform mat4 projectionMatrix, modelViewMatrix;
            uniform float drawFlag;
            uniform vec4 lightPosition, lightAmbient, lightDiffuse, lightSpecular;

            varying vec3 L, N, V;
            varying float fragFlag;
            varying vec4 diffuseProduct, specularProduct, ambientProduct;
            varying float onlyAmbientFrag;
            varying vec2 texCoords;

            void calculateLight(){
                if(onlyAmbient == 0.0){
                    specularProduct = lightSpecular * matSpecular;
                    diffuseProduct = lightDiffuse * matDiffuse;
                    vec3 pos = (modelViewMatrix * vPosition).xyz;
                    N = normalize(modelViewMatrix * vNormal).xyz;
                    L = normalize(lightPosition.xyz - pos);
                    V =  normalize(-pos);
                }
                onlyAmbientFrag = onlyAmbient;
            }

            void main() {
                ambientProduct = lightAmbient * vec4(0.3, 0.3, 0.3, 1.0);
                calculateLight();
                texCoords = vTexture;
                fragFlag=drawFlag;
                if(drawFlag == 5.0){
                    gl_Position = projectionMatrix * modelViewMatrix * vPosition;
                }
                if(drawFlag == 4.0){
                    gl_Position = projectionMatrix * modelViewMatrix * vPosition;
                }
                if(drawFlag == 3.0){
                    gl_Position = projectionMatrix * modelViewMatrix * vPosition;
                }
                if(drawFlag == 2.0){
                   gl_Position = projectionMatrix * modelViewMatrix * vPosition;
                }
                if(drawFlag == 1.0){
                    gl_Position = projectionMatrix * modelViewMatrix * vPosition;
                }
            }

        </script>

        <script id="fshader" type="x-shader/x-fragment">
            precision mediump float;
            varying float fragFlag;
            varying vec3 L, N, V;
            varying vec4 diffuseProduct, specularProduct, ambientProduct;
            varying float onlyAmbientFrag;
            varying vec2 texCoords;

            uniform sampler2D texStreet;
            uniform sampler2D texSign;
            uniform sampler2D texLamp;
            uniform sampler2D texCar;
            uniform sampler2D texBunnicula;

            uniform float textured;

            void calculateAndDrawWithLight(sampler2D texture){
                vec4 diffuse = diffuseProduct * dot(L, N);
                vec3 R = (2.0 * dot(L, N) * N) - L;
                vec4 specular = specularProduct * pow(max(dot(V, R), 0.0), 30.0);
                vec4 fColor = diffuse + specular + ambientProduct;
                fColor.a = 1.0;
                gl_FragColor = textured == 0.0 ? fColor: texture2D(texture, texCoords) * fColor;
            }

            void main() {
                    if(fragFlag == 5.0){
                        if(onlyAmbientFrag == 0.0)
                            calculateAndDrawWithLight(texSign);
                        else
                            gl_FragColor = textured == 0.0 ? ambientProduct: texture2D(texSign, texCoords) * ambientProduct;
                    }
                    if(fragFlag == 4.0){
                        if(onlyAmbientFrag == 0.0)
                            calculateAndDrawWithLight(texStreet);
                        else
                            gl_FragColor = textured == 0.0 ? ambientProduct: texture2D(texStreet, texCoords) * ambientProduct;
                    }
                    if(fragFlag == 3.0){
                        if(onlyAmbientFrag == 0.0)
                            calculateAndDrawWithLight(texCar);
                        else
                            gl_FragColor = textured == 0.0 ? ambientProduct: texture2D(texCar, texCoords) * ambientProduct;
                    }
                    if(fragFlag == 2.0){
                        if(onlyAmbientFrag == 0.0)
                            calculateAndDrawWithLight(texLamp);
                        else
                            gl_FragColor = textured == 0.0 ? ambientProduct: texture2D(texLamp, texCoords) * ambientProduct;
                    }
                    if(fragFlag == 1.0){
                        if(onlyAmbientFrag == 0.0)
                            calculateAndDrawWithLight(texBunnicula);
                        else
                            gl_FragColor = textured == 0.0 ? ambientProduct: texture2D(texBunnicula, texCoords) * ambientProduct;
                    }
            }
        </script>

        <script type="text/javascript" src="lib/webgl-utils.js"></script>
        <script type="text/javascript" src="lib/initShaders.js"></script>
        <script type="text/javascript" src="lib/MV.js"></script>

        <script type="text/javascript" src="lib/model.js"></script>
        <script type="text/javascript" src="lib/face.js"></script>
        <script type="text/javascript" src="main.js"></script>

    </head>

    <body onload="main()">
        <h1 id="mode">CS 4731 Final Project</h1>

        <canvas id="webgl" class="box" width="1600" height="900">
            Please use a browser that supports the "canvas" tag.
        </canvas>
    </body>
</html>
